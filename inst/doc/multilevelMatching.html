<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Shu Yang" />

<meta name="date" content="2018-07-23" />

<title>multilevelMatching Tutorial</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">multilevelMatching Tutorial</h1>
<h4 class="author"><em>Shu Yang</em></h4>
<h4 class="date"><em>2018-07-23</em></h4>



<div id="title" class="section level3">
<h3>Title</h3>
<p>Propensity Score Matching and Subclassification in Observational Studies with Multi-level Treatments</p>
</div>
<div id="description" class="section level3">
<h3>Description</h3>
<p>In setting with Multi-level treatments, our goal is to estimate pairwise average treatment effects from a common population using matching methods.</p>
<p>This goal can not be acheived by matching one treatment with another one at a time, since the pairwise matched samples may differ from the target population systematically, and thus they are not compatitable. One implication is that from this approach, it is possible that treatment A is better than treatment B, treatment B is better than treatment C, and treatment C is better than treatment A.</p>
<p>We focus on estimating the average values of potential outcomes for each treatment level by matching methods, which facilitate estimation of pairwise average treatment effects for a common population.</p>
<p>The estimation methods include generalized propensity score (GPS) matching, GPS stratification, matching with the full set of covariates, matching with the full set of GPS vector. Note that GPS matching and GPS straticication only require matching on a scalar function when estimating the average value of the potential outcome at a particular treatment level, which reduces the matching dimension to one, regardless of the number of covariates and the number of treatment levels.</p>
<p>In order to ensure sufficient overlap, Crump et al. (2009)â€™s trimming method can be extended to this setting as well.</p>
</div>
<div id="install" class="section level3">
<h3>Install</h3>
<p>with <code>devtools</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;shuyang1987/multilevelMatching&quot;</span>)</a></code></pre></div>
</div>
<div id="use" class="section level3">
<h3>Use</h3>
<ul>
<li>In the development version <code>v0.1.0.9000+</code>, the <code>multiMatch()</code> function was introduced to combine the <code>multilevelMatchX()</code> and <code>multilevelGPSMatch()</code> functions.</li>
<li>For stratification on the propensity score, use <code>multilevelGPSStratification</code>.</li>
</ul>
<!-- There are only three functions in this package.  -->
<!-- `multilevelMatchX()`,\code{\link{multilevelMatchX}}; -->
<!-- `multilevelGPSMatch()`, \code{\link{multilevelGPSMatch}}; -->
<!-- `multilevelGPSStratification()` \code{\link{multilevelGPSStratification}} make super awesome illustrations.  -->
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(multilevelMatching)</a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">X&lt;-<span class="kw">c</span>(<span class="fl">5.5</span>,<span class="fl">10.6</span>,<span class="fl">3.1</span>,<span class="fl">8.7</span>,<span class="fl">5.1</span>,<span class="fl">10.2</span>,<span class="fl">9.8</span>,<span class="fl">4.4</span>,<span class="fl">4.9</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">Y&lt;-<span class="kw">c</span>(<span class="dv">102</span>,<span class="dv">105</span>,<span class="dv">120</span>,<span class="dv">130</span>,<span class="dv">100</span>,<span class="dv">80</span>,<span class="dv">94</span>,<span class="dv">108</span>,<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">W&lt;-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">multilevelMatchX</span>(Y,W,X)</a></code></pre></div>
<pre><code>## $tauestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##  -10.666667    6.666667   17.333333 
## 
## $varestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##    9.111111  615.580247  613.925926</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="dv">0</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>)</a></code></pre></div>
<pre><code>## $tauestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##  -10.444444    6.666667   17.111111 
## 
## $varestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##    8.545953  616.913580  611.122085 
## 
## $varestimateAI2012
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##    8.302024  411.456234  434.247037 
## 
## $analysisidx
## [1] 1 2 3 4 5 6 7 8 9</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="dv">1</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>)</a></code></pre></div>
<pre><code>## $tauestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##      -9.375       5.875      15.250 
## 
## $varestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##    7.794922  582.654297  576.304688 
## 
## $varestimateAI2012
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##    5.072057  383.848575  430.978089 
## 
## $analysisidx
## 1 2 4 5 6 7 8 9 
## 1 2 4 5 6 7 8 9</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">multiMatch</span>(Y,W,X, <span class="dt">match_on =</span> <span class="st">&quot;covariates&quot;</span>)<span class="op">$</span>results</a></code></pre></div>
<pre><code>## no unit IDs supplied; unit_ids will be assigned generically</code></pre>
<pre><code>## Warning in prepareData(Y = Y, W = W, X = X, match_on = match_on, trimming
## = trimming, : It is recommended that X is a matrix. X will be coerced to a
## matrix.</code></pre>
<pre><code>##         Param Trt1 Trt2   Estimate   Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2 -10.666667   9.111111             NA
## 2 EY(3)-EY(1)    1    3   6.666667 615.580247             NA
## 3 EY(3)-EY(2)    2    3  17.333333 613.925926             NA</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">multiMatch</span>(Y,W,X,<span class="dt">trimming =</span> <span class="dv">0</span>, <span class="dt">match_on =</span> <span class="st">&quot;multinom&quot;</span>)<span class="op">$</span>results</a></code></pre></div>
<pre><code>## no unit IDs supplied; unit_ids will be assigned generically</code></pre>
<pre><code>## Warning in prepareData(Y = Y, W = W, X = X, match_on = match_on, trimming
## = trimming, : It is recommended that X is a matrix. X will be coerced to a
## matrix.</code></pre>
<pre><code>##         Param Trt1 Trt2   Estimate   Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2 -10.444444   8.545953       8.302024
## 2 EY(3)-EY(1)    1    3   6.666667 616.913580     411.456234
## 3 EY(3)-EY(2)    2    3  17.111111 611.122085     434.247037</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">multiMatch</span>(Y,W,X,<span class="dt">trimming =</span> <span class="dv">1</span>, <span class="dt">match_on =</span> <span class="st">&quot;multinom&quot;</span>)<span class="op">$</span>results</a></code></pre></div>
<pre><code>## no unit IDs supplied; unit_ids will be assigned generically</code></pre>
<pre><code>## Warning in prepareData(Y = Y, W = W, X = X, match_on = match_on, trimming
## = trimming, : It is recommended that X is a matrix. X will be coerced to a
## matrix.</code></pre>
<pre><code>##         Param Trt1 Trt2 Estimate   Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2   -9.375   7.794922       5.072057
## 2 EY(3)-EY(1)    1    3    5.875 582.654297     383.848575
## 3 EY(3)-EY(2)    2    3   15.250 576.304688     430.978089</code></pre>
<div id="user-supplied-propensity-scores" class="section level4">
<h4>User-supplied propensity scores</h4>
<p>The user can supply propensity scores through the <code>X</code> argument by setting <code>GPSM=&quot;existing&quot;</code> in <code>multilevelGPSMatch()</code> or <code>multilevelGPSStratification()</code></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">pr_w1 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="fl">0.3</span>,<span class="fl">0.5</span>), <span class="dt">replace=</span><span class="ot">TRUE</span>, <span class="dt">size=</span><span class="kw">length</span>(W))</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">pr_w2 &lt;-<span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>pr_w1)<span class="op">/</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">pr_w3 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">-</span>(pr_w1<span class="op">+</span>pr_w2)</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">existing_GPS_matrix &lt;-<span class="st"> </span><span class="kw">cbind</span>(pr_w1, pr_w2,pr_w3)</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="co">#the following checks are also carried out under the hood</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="kw">nrow</span>(existing_GPS_matrix)<span class="op">==</span><span class="kw">length</span>(W)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">ncol</span>(existing_GPS_matrix)<span class="op">==</span><span class="kw">length</span>(<span class="kw">unique</span>(W))</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">all</span>(<span class="kw">rowSums</span>(existing_GPS_matrix)<span class="op">==</span><span class="dv">1</span>)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">multilevelGPSMatch</span>(<span class="dt">Y=</span>Y,<span class="dt">W=</span>W,<span class="dt">X=</span>existing_GPS_matrix,<span class="dt">Trimming=</span><span class="dv">0</span>,<span class="dt">GPSM=</span><span class="st">&quot;existing&quot;</span>)</a></code></pre></div>
<pre><code>## $tauestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
## -12.8888889 -12.6666667   0.2222222 
## 
## $varestimate
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##    20.78875   631.39506   618.16735 
## 
## $varestimateAI2012
## EY(2)-EY(1) EY(3)-EY(1) EY(3)-EY(2) 
##          NA          NA          NA 
## 
## $analysisidx
## [1] 1 2 3 4 5 6 7 8 9</code></pre>
</div>
</div>
<div id="another-example" class="section level3">
<h3>Another example</h3>
<p>A more complex dataset:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">111</span>)</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">n    &lt;-<span class="st"> </span><span class="dv">5000</span><span class="op">*</span><span class="dv">6</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="co"># X1-X3 3 MVN var 2, 1, 1, covars 1, -1, -.5</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4">vars   &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">covars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span>.<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">mu     &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">tau    &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8">Sigma &lt;-<span class="st"> </span><span class="kw">diag</span>(vars)</a>
<a class="sourceLine" id="cb29-9" data-line-number="9">Sigma[<span class="dv">2</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">1</span>,<span class="dv">2</span>] &lt;-<span class="st"> </span>covars[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb29-10" data-line-number="10">Sigma[<span class="dv">3</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">1</span>,<span class="dv">3</span>] &lt;-<span class="st"> </span>covars[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb29-11" data-line-number="11">Sigma[<span class="dv">3</span>,<span class="dv">2</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">2</span>,<span class="dv">3</span>] &lt;-<span class="st"> </span>covars[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb29-12" data-line-number="12">trt1 &lt;-<span class="st"> </span><span class="dv">100</span>; trt1</a></code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">trt2 &lt;-<span class="st"> </span><span class="dv">100</span>; trt2</a></code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">trt3 &lt;-<span class="st"> </span><span class="dv">100</span>; trt3</a></code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co"># draw Xs</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="kw">library</span>(MASS)</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">X13 &lt;-<span class="st"> </span><span class="kw">mvrnorm</span>(n,<span class="dt">mu=</span>mu,<span class="dt">Sigma=</span>Sigma, <span class="dt">empirical =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">X1 &lt;-<span class="st"> </span>X13[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">X2 &lt;-<span class="st"> </span>X13[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb35-6" data-line-number="6">X3 &lt;-<span class="st"> </span>X13[,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb35-7" data-line-number="7">X4 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="op">-</span><span class="dv">3</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb35-8" data-line-number="8">X5 &lt;-<span class="st"> </span><span class="kw">rchisq</span>(n, <span class="dt">df=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb35-9" data-line-number="9">X6 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n,<span class="dt">size=</span><span class="dv">1</span>,<span class="dt">prob=</span>.<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb35-10" data-line-number="10"></a>
<a class="sourceLine" id="cb35-11" data-line-number="11">xb2 &lt;-<span class="st"> </span><span class="fl">0.1</span><span class="op">*</span>(X1<span class="op">^</span><span class="dv">2</span><span class="op">+</span>X2<span class="op">+</span>X3<span class="op">+</span>X4<span class="op">+</span>X5<span class="op">+</span>X6)</a>
<a class="sourceLine" id="cb35-12" data-line-number="12">xb3 &lt;-<span class="st"> </span><span class="fl">0.1</span><span class="op">*</span>(X1<span class="op">+</span>X2<span class="op">^</span><span class="dv">2</span><span class="op">+</span>X3<span class="op">^</span><span class="dv">2</span><span class="op">+</span>X4<span class="op">+</span>X5<span class="op">+</span>X6)</a>
<a class="sourceLine" id="cb35-13" data-line-number="13">exb2&lt;-<span class="kw">exp</span>(xb2)</a>
<a class="sourceLine" id="cb35-14" data-line-number="14">exb3&lt;-<span class="kw">exp</span>(xb3)</a>
<a class="sourceLine" id="cb35-15" data-line-number="15">pi1&lt;-<span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>(xb2)<span class="op">+</span><span class="kw">exp</span>(xb3))</a>
<a class="sourceLine" id="cb35-16" data-line-number="16">pi2&lt;-<span class="kw">exp</span>(xb2)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>(xb2)<span class="op">+</span><span class="kw">exp</span>(xb3))</a>
<a class="sourceLine" id="cb35-17" data-line-number="17">pi3&lt;-<span class="kw">exp</span>(xb3)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>(xb2)<span class="op">+</span><span class="kw">exp</span>(xb3))</a>
<a class="sourceLine" id="cb35-18" data-line-number="18">pi&lt;-<span class="kw">cbind</span>(pi1,pi2,pi3)</a>
<a class="sourceLine" id="cb35-19" data-line-number="19"><span class="kw">apply</span>(pi,<span class="dv">2</span>,mean)</a></code></pre></div>
<pre><code>##       pi1       pi2       pi3 
## 0.2637337 0.3681104 0.3681559</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">W&lt;-<span class="kw">matrix</span>(<span class="ot">NA</span>,n,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"><span class="kw">colnames</span>(W)   &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>,<span class="st">&quot;W2&quot;</span>,<span class="st">&quot;W3&quot;</span>,<span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="cf">for</span>(kk <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n){</a>
<a class="sourceLine" id="cb37-4" data-line-number="4">    W[kk,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]&lt;-<span class="kw">rmultinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dt">prob =</span> pi[kk,])</a>
<a class="sourceLine" id="cb37-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb37-6" data-line-number="6"></a>
<a class="sourceLine" id="cb37-7" data-line-number="7">sim.dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(W,X1,X2,X3,X4,X5,X6)</a>
<a class="sourceLine" id="cb37-8" data-line-number="8">trt1.keep &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(sim.dat<span class="op">$</span>W1<span class="op">==</span><span class="dv">1</span>),trt1,<span class="dt">replace=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb37-9" data-line-number="9">trt2.keep &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(sim.dat<span class="op">$</span>W2<span class="op">==</span><span class="dv">1</span>),trt2,<span class="dt">replace=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb37-10" data-line-number="10">trt3.keep &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(sim.dat<span class="op">$</span>W3<span class="op">==</span><span class="dv">1</span>),trt3,<span class="dt">replace=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb37-11" data-line-number="11">sim.dat &lt;-<span class="st"> </span>sim.dat[<span class="kw">c</span>(trt1.keep,trt2.keep,trt3.keep),]</a>
<a class="sourceLine" id="cb37-12" data-line-number="12">sim.dat[,<span class="st">&quot;W&quot;</span>]&lt;-sim.dat[,<span class="st">&quot;W1&quot;</span>]<span class="op">+</span><span class="dv">2</span><span class="op">*</span>sim.dat[,<span class="st">&quot;W2&quot;</span>]<span class="op">+</span><span class="dv">3</span><span class="op">*</span>sim.dat[,<span class="st">&quot;W3&quot;</span>]</a>
<a class="sourceLine" id="cb37-13" data-line-number="13">sim.dat[,<span class="st">&quot;W&quot;</span>]&lt;-<span class="kw">as.factor</span>(sim.dat[,<span class="st">&quot;W&quot;</span>])</a>
<a class="sourceLine" id="cb37-14" data-line-number="14">W &lt;-<span class="st"> </span>sim.dat[,<span class="st">&quot;W&quot;</span>]</a>
<a class="sourceLine" id="cb37-15" data-line-number="15">X &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(sim.dat[,<span class="kw">names</span>(sim.dat)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)]])</a>
<a class="sourceLine" id="cb37-16" data-line-number="16">X1 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X1&quot;</span>]; X2 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X2&quot;</span>]; X3 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X3&quot;</span>]; X4 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X4&quot;</span>]; X5 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X5&quot;</span>];X6 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X6&quot;</span>]</a>
<a class="sourceLine" id="cb37-17" data-line-number="17"></a>
<a class="sourceLine" id="cb37-18" data-line-number="18"><span class="co"># outcome: treatment effect is zero</span></a>
<a class="sourceLine" id="cb37-19" data-line-number="19">u  &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(X))</a>
<a class="sourceLine" id="cb37-20" data-line-number="20"><span class="co"># outcome (linear)</span></a>
<a class="sourceLine" id="cb37-21" data-line-number="21">Y &lt;-<span class="st">    </span>(W<span class="op">==</span><span class="dv">1</span>)<span class="op">*</span>(  X1 <span class="op">+</span><span class="st">   </span>X2 <span class="op">+</span><span class="st">   </span>X3 <span class="op">+</span><span class="st">   </span>X4 <span class="op">+</span><span class="st">    </span>X5<span class="dv">-1</span> <span class="op">+</span><span class="st">     </span>X6<span class="fl">-0.5</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb37-22" data-line-number="22">(W<span class="op">==</span><span class="dv">2</span>)<span class="op">*</span>(<span class="dv">2</span><span class="op">*</span>X1 <span class="op">+</span><span class="st"> </span><span class="dv">3</span><span class="op">*</span>X2 <span class="op">+</span><span class="st">   </span>X3 <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>X4 <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>(X5<span class="dv">-1</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>(X6<span class="fl">-0.5</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb37-23" data-line-number="23">(W<span class="op">==</span><span class="dv">3</span>)<span class="op">*</span>(<span class="dv">3</span><span class="op">*</span>X1 <span class="op">+</span><span class="st">   </span>X2 <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>X3 <span class="op">-</span><span class="st">   </span>X4 <span class="op">-</span><span class="st">   </span>(X5<span class="dv">-1</span>) <span class="op">-</span><span class="st">   </span>(X6<span class="fl">-0.5</span>))<span class="op">+</span>u</a>
<a class="sourceLine" id="cb37-24" data-line-number="24"></a>
<a class="sourceLine" id="cb37-25" data-line-number="25">W &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">as.character</span>(W)) ## Factors give issues sometimes</a></code></pre></div>
<p>We can estimate this by:</p>
<div id="matching-on-the-covariates" class="section level4">
<h4>Matching on the covariates</h4>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">match1  &lt;-<span class="st"> </span><span class="kw">multilevelMatchX</span>(Y,W,X)</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">match1b &lt;-<span class="st"> </span><span class="kw">multiMatch</span>(Y,W,X, <span class="dt">match_on=</span><span class="st">&quot;covariates&quot;</span>)</a>
<a class="sourceLine" id="cb38-3" data-line-number="3"></a>
<a class="sourceLine" id="cb38-4" data-line-number="4">match1<span class="op">$</span>results</a></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">match1b<span class="op">$</span>results</a></code></pre></div>
<pre><code>##         Param Trt1 Trt2   Estimate  Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2 0.07927361 0.1792186             NA
## 2 EY(3)-EY(1)    1    3 0.86264929 0.1634754             NA
## 3 EY(3)-EY(2)    2    3 0.78337567 0.3221616             NA</code></pre>
</div>
<div id="matching-on-estimated-propensity-scores" class="section level4">
<h4>Matching on estimated propensity scores</h4>
<div id="multinomial-logistic-regression" class="section level5">
<h5>Multinomial logistic regression</h5>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">match2  &lt;-<span class="st"> </span><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="ot">FALSE</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>) </a>
<a class="sourceLine" id="cb42-2" data-line-number="2">match2b &lt;-<span class="st"> </span><span class="kw">multiMatch</span>(Y,W,X,<span class="dt">trimming=</span><span class="ot">FALSE</span>,<span class="dt">match_on=</span><span class="st">&quot;multinom&quot;</span>) </a>
<a class="sourceLine" id="cb42-3" data-line-number="3">match3  &lt;-<span class="st"> </span><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="ot">TRUE</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>) </a>
<a class="sourceLine" id="cb42-4" data-line-number="4">match3b  &lt;-<span class="st"> </span><span class="kw">multiMatch</span>(Y,W,X,<span class="dt">trimming=</span><span class="ot">TRUE</span>,<span class="dt">match_on=</span><span class="st">&quot;multinom&quot;</span>)</a>
<a class="sourceLine" id="cb42-5" data-line-number="5"></a>
<a class="sourceLine" id="cb42-6" data-line-number="6">match2<span class="op">$</span>results</a></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">match2b<span class="op">$</span>results</a></code></pre></div>
<pre><code>##         Param Trt1 Trt2   Estimate  Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2 -0.7458499 0.6974908      0.4340571
## 2 EY(3)-EY(1)    1    3  0.5605192 0.4856579      0.2287787
## 3 EY(3)-EY(2)    2    3  1.3063691 0.7089620      0.4226466</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">match3<span class="op">$</span>results</a></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">match3b<span class="op">$</span>results</a></code></pre></div>
<pre><code>##         Param Trt1 Trt2  Estimate  Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2 -1.056445 0.7924310      0.4876396
## 2 EY(3)-EY(1)    1    3  1.001189 0.4457239      0.2104603
## 3 EY(3)-EY(2)    2    3  2.057634 0.8310264      0.4624069</code></pre>
</div>
<div id="proportional-odds-logistic-regression" class="section level5">
<h5>Proportional odds logistic regression:</h5>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1">match4 &lt;-<span class="st"> </span><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="dv">0</span>, <span class="dt">GPSM=</span><span class="st">&quot;ordinallogisticReg&quot;</span>)</a>
<a class="sourceLine" id="cb50-2" data-line-number="2">match4b &lt;-<span class="st"> </span><span class="kw">multiMatch</span>(Y,W,X,<span class="dt">match_on =</span> <span class="st">&quot;polr&quot;</span>)</a>
<a class="sourceLine" id="cb50-3" data-line-number="3"></a>
<a class="sourceLine" id="cb50-4" data-line-number="4">match4<span class="op">$</span>results</a></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">match4b<span class="op">$</span>results</a></code></pre></div>
<pre><code>##         Param Trt1 Trt2   Estimate  Variance VarianceAI2016
## 1 EY(2)-EY(1)    1    2 -0.7303810 0.7261450             NA
## 2 EY(3)-EY(1)    1    3  0.3711491 0.5966005             NA
## 3 EY(3)-EY(2)    2    3  1.1015301 0.9743341             NA</code></pre>
</div>
</div>
<div id="stratifying-on-generalized-propensity-scores" class="section level4">
<h4>Stratifying on generalized propensity scores</h4>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1">strat1  &lt;-<span class="st"> </span><span class="kw">multilevelGPSStratification</span>(Y,W,X,<span class="dt">NS=</span><span class="dv">10</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>,<span class="dt">linearp=</span><span class="dv">0</span>,<span class="dt">nboot=</span><span class="dv">50</span>)</a>
<a class="sourceLine" id="cb54-2" data-line-number="2"></a>
<a class="sourceLine" id="cb54-3" data-line-number="3">strat1<span class="op">$</span>results</a></code></pre></div>
<pre><code>## NULL</code></pre>
</div>
</div>
<div id="a-note-on-multimatch" class="section level3">
<h3>A note on <code>multiMatch()</code></h3>
<p>The <code>multiMatch()</code> function may return slightly different estimates than the original 2 matching functions in certain circumstances. We attempt to ensure that the functions implement are identical methods up to perhaps random number generation. Please file an issue if you have any questions or concerns. Or, see the NEWS.md.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
